<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Brochure Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-slate-100 text-slate-900">
    <main class="mx-auto max-w-5xl p-6 lg:p-10">
      <header class="mb-6">
        <h1 class="text-3xl font-bold">Brochure Hub</h1>
        <p class="text-sm text-slate-600">Generate customer-ready messaging from Hyundai brochure data.</p>
      </header>

      <section class="rounded-xl bg-white p-5 shadow-sm ring-1 ring-slate-200">
        <div class="grid gap-4 md:grid-cols-2">
          <label class="block">
            <span class="mb-1 block text-sm font-medium">Year</span>
            <select id="yearSelect" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm"></select>
          </label>

          <label class="block">
            <span class="mb-1 block text-sm font-medium">Model</span>
            <select id="modelSelect" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm"></select>
          </label>
        </div>

        <label class="mt-4 block">
          <span class="mb-1 block text-sm font-medium">Customer Notes</span>
          <textarea
            id="customerNotes"
            rows="6"
            class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm"
            placeholder="Example: Family of 4, safety focused, wants AWD, budget-conscious monthly payment..."
          ></textarea>
        </label>

        <div class="mt-4 flex flex-wrap gap-2">
          <button id="generateBtn" class="rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700">Generate</button>
          <button id="openPdfBtn" class="rounded-md bg-slate-700 px-4 py-2 text-sm font-medium text-white hover:bg-slate-800">Open PDF</button>
          <button id="openRawBtn" class="rounded-md bg-slate-700 px-4 py-2 text-sm font-medium text-white hover:bg-slate-800">Open Raw</button>
          <button id="copyBtn" class="rounded-md bg-emerald-600 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-700">Copy Output</button>
          <button id="clearBtn" class="rounded-md bg-amber-600 px-4 py-2 text-sm font-medium text-white hover:bg-amber-700">Clear Output</button>
        </div>

        <div id="status" class="mt-3 min-h-6 text-sm text-slate-700"></div>
      </section>

      <section class="mt-6 rounded-xl bg-white p-5 shadow-sm ring-1 ring-slate-200">
        <h2 class="mb-2 text-lg font-semibold">Generated Output</h2>
        <pre id="outputArea" class="min-h-48 whitespace-pre-wrap rounded-md bg-slate-950 p-4 text-sm text-slate-100"></pre>
      </section>
    </main>

    <script>
      let manifestData = null;
      let modelEntries = [];

      const yearSelect = document.getElementById("yearSelect");
      const modelSelect = document.getElementById("modelSelect");
      const customerNotes = document.getElementById("customerNotes");
      const generateBtn = document.getElementById("generateBtn");
      const openPdfBtn = document.getElementById("openPdfBtn");
      const openRawBtn = document.getElementById("openRawBtn");
      const copyBtn = document.getElementById("copyBtn");
      const clearBtn = document.getElementById("clearBtn");
      const outputArea = document.getElementById("outputArea");
      const statusEl = document.getElementById("status");

      function setStatus(message, isError = false) {
        statusEl.textContent = message;
        statusEl.className = `mt-3 min-h-6 text-sm ${isError ? "text-red-700" : "text-slate-700"}`;
      }

      function normalizeDataPath(pathValue) {
        if (!pathValue) return null;
        if (pathValue.startsWith("../") || pathValue.startsWith("http://") || pathValue.startsWith("https://")) {
          return pathValue;
        }
        if (pathValue.startsWith("data/Hyundai/")) {
          return `../${pathValue}`;
        }
        return `../data/Hyundai/${pathValue.replace(/^\/+/, "")}`;
      }

      function getSelectedModelEntry() {
        const index = Number(modelSelect.value);
        if (Number.isNaN(index) || index < 0 || index >= modelEntries.length) {
          return null;
        }
        return modelEntries[index];
      }

      function getSelectedPaths() {
        const year = yearSelect.value;
        const entry = getSelectedModelEntry();
        if (!year || !entry) {
          return { year, modelKey: "", pdfUrl: "", rawUrl: "" };
        }

        const modelKey = entry.key;
        const fallbackPdf = `../data/Hyundai/${year}/${modelKey}/${modelKey}_Brochure.pdf`;
        const fallbackRaw = `../data/Hyundai/${year}/${modelKey}/${modelKey}_Raw.md`;

        return {
          year,
          modelKey,
          pdfUrl: normalizeDataPath(entry.brochure) || fallbackPdf,
          rawUrl: normalizeDataPath(entry.raw) || fallbackRaw,
        };
      }

      function updateOpenButtons() {
        const { year, modelKey, pdfUrl, rawUrl } = getSelectedPaths();
        const disabled = !year || !modelKey;
        openPdfBtn.disabled = disabled;
        openRawBtn.disabled = disabled;
        openPdfBtn.dataset.url = pdfUrl;
        openRawBtn.dataset.url = rawUrl;
      }

      function getAvailableYears() {
        if (manifestData?.years && typeof manifestData.years === "object") {
          return Object.keys(manifestData.years).sort((a, b) => Number(b) - Number(a));
        }
        if (manifestData?.year) {
          return [String(manifestData.year)];
        }
        return [];
      }

      function getModelsForYear(year) {
        if (manifestData?.years?.[year]?.models && Array.isArray(manifestData.years[year].models)) {
          return manifestData.years[year].models
            .map((model) => ({
              key: model?.key || model?.modelKey || model?.id || model?.label,
              label: model?.label || model?.name || model?.key || model?.modelKey || "Unknown",
              brochure: model?.brochure,
              raw: model?.raw,
            }))
            .filter((model) => model.key)
            .sort((a, b) => a.label.localeCompare(b.label));
        }

        if (manifestData?.years?.[year] && Array.isArray(manifestData.years[year])) {
          return [...manifestData.years[year]]
            .sort((a, b) => String(a).localeCompare(String(b)))
            .map((modelKey) => ({ key: modelKey, label: modelKey }));
        }

        if (String(manifestData?.year || "") === String(year) && Array.isArray(manifestData?.models)) {
          return [...manifestData.models]
            .sort((a, b) => String(a).localeCompare(String(b)))
            .map((modelKey) => ({ key: modelKey, label: modelKey }));
        }

        return [];
      }

      function populateModels() {
        modelSelect.innerHTML = "";
        modelEntries = getModelsForYear(yearSelect.value);

        modelEntries.forEach((entry, index) => {
          const option = document.createElement("option");
          option.value = String(index);
          option.textContent = entry.label;
          modelSelect.appendChild(option);
        });

        updateOpenButtons();
      }

      function populateYears() {
        yearSelect.innerHTML = "";

        getAvailableYears().forEach((year) => {
          const option = document.createElement("option");
          option.value = year;
          option.textContent = year;
          yearSelect.appendChild(option);
        });

        populateModels();
      }

      async function loadManifest() {
        try {
          const response = await fetch("../data/Hyundai/manifest.json");
          if (!response.ok) {
            throw new Error("Could not load manifest.json");
          }

          manifestData = await response.json();
          populateYears();
          setStatus("Ready.");
        } catch (error) {
          setStatus(`Error loading manifest: ${error.message}`, true);
        }
      }

      async function generateCommunication() {
        const { year, modelKey, rawUrl } = getSelectedPaths();
        const notes = customerNotes.value.trim();

        if (!year || !modelKey || !notes) {
          setStatus("Please choose a year, a model, and provide customer notes.", true);
          return;
        }

        generateBtn.disabled = true;
        generateBtn.textContent = "Generating...";
        setStatus("Loading brochure data...");

        try {
          const rawResponse = await fetch(rawUrl);
          if (!rawResponse.ok) {
            throw new Error("Failed to load Raw.md for selected vehicle.");
          }
          const brochureText = await rawResponse.text();

          const prompt = `You are an expert automotive sales assistant. Use ONLY the provided brochure text to write a customized, persuasive communication to a customer. Map their stated needs to the specific features, safety tech, and trim levels found in the text. Customer Needs: ${notes}. Vehicle Data: ${brochureText}. Provide: (1) a detailed email and (2) a short SMS text.`;

          setStatus("Calling AI proxy...");
          const apiResponse = await fetch("/api/generate", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ prompt }),
          });

          const data = await apiResponse.json().catch(() => ({}));

          if (!apiResponse.ok) {
            if (apiResponse.status === 404) {
              throw new Error("AI route not found. Run on Cloudflare Pages/Functions (Wrangler or deployed Pages).");
            }
            throw new Error(data?.error || "Generation request failed.");
          }

          const outputText = data?.text;
          if (!outputText) {
            throw new Error("API response did not include generated text.");
          }

          outputArea.textContent = outputText;
          setStatus(`Generation complete.${data?.modelUsed ? ` Model: ${data.modelUsed}.` : ""}`);
        } catch (error) {
          setStatus(`Error: ${error.message}`, true);
        } finally {
          generateBtn.disabled = false;
          generateBtn.textContent = "Generate";
        }
      }

      yearSelect.addEventListener("change", populateModels);
      modelSelect.addEventListener("change", updateOpenButtons);

      openPdfBtn.addEventListener("click", () => {
        const url = openPdfBtn.dataset.url;
        if (url) {
          window.open(url, "_blank", "noopener,noreferrer");
        }
      });

      openRawBtn.addEventListener("click", () => {
        const url = openRawBtn.dataset.url;
        if (url) {
          window.open(url, "_blank", "noopener,noreferrer");
        }
      });

      generateBtn.addEventListener("click", generateCommunication);

      copyBtn.addEventListener("click", async () => {
        if (!outputArea.textContent) {
          setStatus("Nothing to copy yet.", true);
          return;
        }

        try {
          await navigator.clipboard.writeText(outputArea.textContent);
          setStatus("Output copied to clipboard.");
        } catch (error) {
          setStatus(`Clipboard failed: ${error.message}`, true);
        }
      });

      clearBtn.addEventListener("click", () => {
        outputArea.textContent = "";
        setStatus("Output cleared.");
      });

      loadManifest();
    </script>
  </body>
</html>
